# 오싹 (OSAK) — 내가 할 일 정리

> **오싹** = 한국 OTT 통합 **주간 인기 TOP10** (YouTube 가중치) + **영상 중심 작품 허브**.  
> 아래는 환경 설정·배포·운영·Cron 호출 방법 정리입니다.

---

## 1. 프로젝트 요약

| 항목 | 내용 |
|------|------|
| **목표** | 주간 인기 랭킹 자동 집계 + 작품 상세에서 예고편·반응·쇼츠·스포방지·굿즈를 한 페이지에서 소비 |
| **인기 순위** | YouTube 가중치(예고편 조회수 + 공식 채널 보너스)로 주간 TOP10 산출, 외부 랭킹 API 없음 |
| **작품 상세** | `/works/[slug]` — Hero → 공식 예고편(iframe) → 유튜브 반응(가로 스크롤·모달 재생) → 쇼츠(9:16·모달) → 스포 방지(펼치기) → 굿즈. **유튜브는 링크 이탈 없이 화면 안에서 재생** |
| **검색** | `works` 테이블 검색(제목·영문·줄거리). 주간/월간이 지나도 랭킹에 올랐던 작품은 **works에 쌓여 있어서 검색으로 조회 가능** |
| **메뉴** | 홈 · 랭킹 · 검색 · 영상 · 작품 · 달력 |

---

## 2. 필수: 환경 설정

### 2-1. Supabase
- [ ] https://supabase.com → New Project, Region **Northeast Asia (Seoul)**
- [ ] Settings > API에서 **Project URL**, **anon public key** 복사

### 2-2. YouTube API 키
- [ ] https://console.cloud.google.com → **YouTube Data API v3** 사용 설정 → API 키 발급

### 2-3. TMDB API 키 (작품 메타·랭킹 후보용)
- [ ] https://www.themoviedb.org → Settings > API → **API Key (v3)** 발급

### 2-4. `.env.local` 작성
- [ ] 프로젝트 루트에 아래 값 채우기:

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...

YOUTUBE_API_KEY=AIzaSy...
TMDB_API_KEY=abc123...
CRON_SECRET=아무랜덤문자열-보안용
```

---

## 3. 데이터베이스 초기화

- [ ] Supabase **SQL Editor**에서 아래 순서로 실행:

| 순서 | 파일 | 설명 |
|------|------|------|
| 1 | `001_initial.sql` | works, videos, pending_videos |
| 2 | `supabase/migrations/002_work_manual_videos_and_end_date.sql` | works에 manual_video_ids, end_date |
| 3 | `supabase/migrations/003_osak_rankings.sql` | platforms, work_platforms, weekly_rankings, monthly_rankings |

---

## 4. 로컬 실행

```bash
npm run dev
```

- [ ] http://localhost:3000 접속
- [ ] 홈(이번주 TOP10) · 랭킹 · 검색 · 영상 · 작품 · 달력 확인

---

## 5. Cron API (자동화)

모든 Cron은 **Header: `X-Cron-Secret: (CRON_SECRET 값)`** 또는 `Authorization: Bearer (CRON_SECRET)` 필요.

| Cron | URL | 주기 (Vercel) | 역할 |
|------|-----|----------------|------|
| **sync-weekly-ranking** | `GET /api/cron/sync-weekly-ranking` | 매주 **일요일 23:59 KST** | YouTube 가중치로 TOP10 계산 → works upsert, weekly_rankings 저장 |
| **sync-monthly-ranking** | `GET /api/cron/sync-monthly-ranking` | **매월 1일 00:00 KST** | 지난달 weekly_rankings 평균 → monthly_rankings 저장 |
| **sync-videos** | `GET /api/cron/sync-videos` | 매일 새벽 3시 KST | 최근 30일 works 기준 예고편·쇼츠·리뷰 수집 → videos 저장 |
| **sync-works** | `GET /api/cron/sync-works` | 매주 목요일 새벽 4시 KST | TMDB 트렌딩(영화+TV 30+30) → works 추가/갱신 |

- [ ] (선택) 수동 1회 호출로 동작 확인: Postman 등에서 `X-Cron-Secret` 넣고 위 URL 호출

---

## 6. 수동/관리자용 API

| 용도 | 메서드 | URL | Body 예시 |
|------|--------|-----|-----------|
| **작품 리스트 추가** | POST | `/api/cron/import-works` | `{ "titles": [ "오징어 게임 2", "듄" ] }` |
| **작품 수동 유튜브 등록** | PATCH | `/api/admin/works/{slug}/manual-videos` | `{ "youtube_ids": [ "VIDEO_ID" ] }` |

---

## 7. 페이지·구조 요약

### 홈 (`/`)
- 이번주 TOP10 (weekly_rankings), 랭킹 보기 CTA
- (기존) 지금 화제 작품, 최근 등록, 공개 예정

### 랭킹 (`/ranking`, `/ranking/archive`, `/ranking/[year]-week-[n]`, `/ranking/[year]-[month]`)
- 이번 주 TOP10
- 지난 인기 보기 → 주간·월간 아카이브 링크

### 작품 상세 (`/works/[slug]`) — 영상 중심 허브
1. **Hero** — 왼쪽 포스터, 오른쪽 제목·시즌/영화·장르·공개일·플랫폼 뱃지·한줄요약
2. **어디서 볼까** — 플랫폼별 컬러 버튼
3. **공식 예고편** — 조회수 1위 1개 또는 수동 등록 첫 번째 → **iframe 16:9** (이탈 없음)
4. **유튜브 반응** — 리뷰·해설·리액션 가로 스크롤 카드 → **클릭 시 모달 iframe 재생**
5. **쇼츠** — 세로 9:16 카드 → **클릭 시 모달 재생**
6. **스포 방지 설명** — 줄거리 펼치기/접기
7. **굿즈** — 포스터·피규어·OST 등 (MVP는 외부 링크 준비 중)

### 검색 (`/search?q=...`)
- `works` 테이블에서 제목·title_en·overview 검색
- 한 번이라도 주간/월간 랭킹에 올랐던 작품은 works에 남아 있어 **검색으로 조회 가능**

---

## 8. 앞으로 할 일 (선택)

| 할 일 | 비고 |
|--------|------|
| **로고** | `public/logo.png` 넣고 헤더에 사용 |
| **NEXT_PUBLIC_SITE_URL** | Vercel 환경 변수에 배포 URL → sitemap/robots 반영 |
| **굿즈 데이터** | 작품별 공식 굿즈·OST·제휴 링크 넣으면 GoodsSection에 표시 (`docs/수익-모델.md` 참고) |
| **Google Trends / 내부 행동** | (2차) 랭킹 점수에 검색량·클릭수·북마크 반영 가능 |

---

## 9. 체크 요약

| 단계 | 내용 | 완료 |
|------|------|------|
| 1 | Supabase·YouTube·TMDB 키, `.env.local` | ☐ |
| 2 | Supabase에 001, 002, 003 마이그레이션 실행 | ☐ |
| 3 | `npm run dev` 로컬 실행·화면 확인 | ☐ |
| 4 | (선택) sync-weekly-ranking 1회 호출 → 랭킹 데이터 생성 | ☐ |
| 5 | (선택) sync-videos 1회 호출 → 작품별 영상 수집 | ☐ |
| 6 | Vercel 배포 + 환경 변수 + 도메인 | ☐ |
